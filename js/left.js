var sbd_config={major_delay:300,minor_delay:100,target_slop:25};var navBarCategories=function(options){this.SetOptions(options);this.navBrowseFylout=$('#'+this.options.navBrowseFylout);this.navCatsWarp=$('#'+this.options.navCatsWarp);this.navCats=$('#'+this.options.navCats);this.navSbucatUrl=this.options.navSbucatUrl;this.IE8=$.browser.msie&&($.browser.version=='8.0');this.Init()};navBarCategories.prototype={SetOptions:function(options){this.options={navBrowseFylout:'navBrowseFylout',navCatsWarp:'navCatsWarp',navCats:'navCats',navSubcatsWarp:'navSubcatsWarp',navSbucatUrl:'http://'+location.hostname+'/web/navsubcats.html'};$.extend(this.options,options||{})},Init:function(){this.InsertContent()},InsertContent:function(){var self=this;$.ajax({url:this.navSbucatUrl,type:"GET",dataType:"html",cache:"false",success:function(data){self.navBrowseFylout.append(data);self.NavInit()}})},NavInit:function(){this.navSubcatsWarp=$('#'+this.options.navSubcatsWarp);var self=this;var rectRelation=function(cursor,rect){var h="c",v="c";if(cursor&&rect){if(cursor.x<rect.x1){h="l"}else{if(cursor.x>rect.x2){h="r"}}if(cursor.y<rect.y1){v="t"}else{if(cursor.y>rect.y2){v="b"}}}return v+h};var notInRect=function(cursor,rect){if(rectRelation(cursor,rect)=="cc"){return false}return true};var calcChangeDelay=function(args,rect){var delay=0,c=args.cursor,p1=args.priorCursors[0]||{},p2=args.priorCursors[1]||{};if(c.x==p1.x&&Math.abs(c.y-p1.y)<2&&c.x>p2.x){delay=sbd_config.minor_delay}else{var r=rect,pts=[c,p1];switch(rectRelation(c,r)){case"tl":pts.push({x:r.x1,y:r.y2},{x:r.x2,y:r.y1});break;case"bl":pts.push({x:r.x1,y:r.y1},{x:r.x2,y:r.y2});break;case"cl":pts.push({x:r.x1,y:r.y1},{x:r.x1,y:r.y2});break;default:pts.push({x:0,y:0},{x:0,y:0});delay=-1}if(delay==0){var b0=(pts[2].x-pts[1].x)*(pts[3].y-pts[1].y)-(pts[3].x-pts[1].x)*(pts[2].y-pts[1].y),b1=((pts[2].x-pts[0].x)*(pts[3].y-pts[0].y)-(pts[3].x-pts[0].x)*(pts[2].y-pts[0].y))/b0,b2=((pts[3].x-pts[0].x)*(pts[1].y-pts[0].y)-(pts[1].x-pts[0].x)*(pts[3].y-pts[0].y))/b0,b3=((pts[1].x-pts[0].x)*(pts[2].y-pts[0].y)-(pts[2].x-pts[0].x)*(pts[1].y-pts[0].y))/b0;delay=(b1>0&&b2>0&&b3>0?sbd_config.major_delay:0)}}return delay};var mouseTracker=function(){var regions=[],n=3,cursor=[{x:0,y:0}],c=0,scroll=[0,0],listening=false;var callbackArgs=function(){var pCursors=[];for(var i=1;i<n;i++){pCursors.push(cursor[(c-i+n)%n])}return $.extend(true,{},{cursor:cursor[c],priorCursors:pCursors})};var check=function(immediately){for(var i=0;i<regions.length;i++){var r=regions[i];var inside=$.grep(r.rects,function(n){return cursor[c].x>=n[0]&&cursor[c].y>=n[1]&&cursor[c].x<n[0]+n[2]&&cursor[c].y<n[1]+n[3]}).length>0;if(r.inside!==null&&inside&&!r.inside&&r.mouseEnter){r.inside=r.mouseEnter(callbackArgs())}else{if(r.inside!==null&&!inside&&r.inside&&r.mouseLeave){r.inside=!r.mouseLeave(immediately,callbackArgs())}}}};var startListening=function(){scroll=[$(window).scrollLeft(),$(window).scrollTop()];$(document).mousemove(function(e){c=(c+1)%n;cursor[c]={x:e.pageX,y:e.pageY};check()});listening=true};return{add:function(rectsArray,options){if(!listening){startListening()}var r=$.extend({rects:rectsArray},options);regions.push(r);return r},remove:function(region){for(var i=0;i<regions.length;i++){if(regions[i]===region){regions.splice(i,1);return}}},checkNow:function(){check(true)},getCallbackArgs:function(){return callbackArgs()}}}();var doCatChange=function(cat,args){var $subcatWarp=self.navSubcatsWarp;$subcat=$("#navSubcats"+cat),$subcatChild=$subcat.children(),$catWarp=self.navCatsWarp,$cat=$("#navCat"+cat);$subcatWarp.css({display:"block",visibility:"hidden"});$subcat.css({display:"block",visibility:"hidden"});if(activeCat){$("#navSubcats"+activeCat).css({display:"none",visibility:"hidden"});$("#navCat"+activeCat).removeClass("cat_active")}var $subcatWarpHeight=$catWarp.outerHeight('true'),$subcatWarpWidth=0;if(self.IE8){$subcatWarpHeight--}for(var i=0;i<$subcatChild.length;i++){$subcatWarpWidth+=parseInt($($subcatChild[i]).outerWidth('true'))}$cat.addClass("cat_active");$subcatWarp.css({top:$catWarp.offset().top,left:$catWarp.offset().left+$catWarp.outerWidth()-2,visibility:"visible",width:$subcatWarpWidth,height:$subcatWarpHeight});$subcat.css({visibility:"visible"});var offset=$subcat.offset(),x1=offset.left,y1=offset.top-sbd_config.target_slop,x2=x1+$subcat.outerWidth(),y2=y1+$subcat.outerHeight()+sbd_config.target_slop;return{x1:x1,y1:y1,x2:x2,y2:y2}};var mt=mouseTracker,subcatRect,delayedChange,activeCat,priorCursor,mtRegions=[];this.navActive=function(){this.navCats.children('li').each(function(){var match=/^navCat(.+)/.exec(this.id),cat=(match?match[1]:"");var mouseEnter=function(args){clearTimeout(delayedChange);$("nav_cat_"+cat).addClass("cat_active");if(activeCat!==cat){var changeDelay=calcChangeDelay(args,subcatRect);if(activeCat&&changeDelay>0){var doDelayedChange=function(){clearTimeout(delayedChange);var delayedArgs=mt.getCallbackArgs(),delayedDelay=0;if(priorCursor&&priorCursor.x==delayedArgs.cursor.x&&priorCursor.y==delayedArgs.cursor.y){if(notInRect(delayedArgs.cursor,subcatRect)){delayedDelay=0}else{delayedDelay=-1}}else{delayedDelay=calcChangeDelay(delayedArgs,subcatRect)}priorCursor={x:delayedArgs.cursor.x,y:delayedArgs.cursor.y};if(delayedDelay>0){if(activeCat!==cat){delayedChange=setTimeout(doDelayedChange,delayedDelay)}}else{if(delayedDelay>-1){subcatRect=doCatChange(cat,args);activeCat=cat}}};delayedChange=setTimeout(doDelayedChange,changeDelay)}else{subcatRect=doCatChange(cat,args);activeCat=cat}}return true};var mouseLeave=function(immediately,args){$("#nav_cat_"+cat).removeClass("nav_hover");return true};var $this=$(this),offset=$this.offset(),added=mt.add([[offset.left,offset.top,$this.outerWidth(),$this.outerHeight()]],{inside:false,mouseEnter:mouseEnter,mouseLeave:mouseLeave});mtRegions.push(added)})};this.navActive();this.navBrowseFylout.mouseleave(function(){onHide();self.navActive()});var onHide=function(){clearTimeout(delayedChange);for(var i=0;i<mtRegions.length;i++){mt.remove(mtRegions[i])}mtRegions=[];subcatRect=null;if(activeCat){$("#navSubcats"+activeCat).css({display:"none",visibility:"hidden"});$("#navCat"+activeCat).removeClass("cat_active")}activeCat=null;self.navSubcatsWarp.css({display:'none',visibility:'visible'})}}};